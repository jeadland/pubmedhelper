<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PubMed Publication Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .results-table {
            max-height: 500px;
            overflow-y: auto;
        }
        .chart-container {
            height: 400px;
            margin-bottom: 2rem;
        }
        .detail-view {
            display: none;
        }
    </style>
</head>
<body>
    <div class="loading">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="container py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>PubMed Publication Analysis</h1>
            <a href="/config" class="btn btn-outline-primary">
                <i class="bi bi-gear"></i> Configure Companies
            </a>
        </div>
        
        <!-- Search String Display -->
        <div class="card mb-4" id="searchStringSection" style="display: none;">
            <div class="card-body">
                <h5 class="card-title">PubMed Search String</h5>
                <div class="alert alert-info">
                    <p><small>Copy this string to search in PubMed directly or click the button below to open in PubMed:</small></p>
                    <div class="d-flex align-items-center gap-2">
                        <code class="bg-light p-2 flex-grow-1" id="searchString" style="word-break: break-all; max-height: 150px; overflow-y: auto; display: block;"></code>
                        <div class="d-flex flex-column gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="copySearchString()">
                                <i class="bi bi-clipboard"></i> Copy
                            </button>
                            <a id="pubmedLink" href="#" target="_blank" class="btn btn-outline-success btn-sm">
                                <i class="bi bi-box-arrow-up-right"></i> Open in PubMed
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Search Form -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="searchForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="topic">Topic (optional - leave blank to see all company publications)</label>
                            <input type="text" class="form-control" id="topic" placeholder="Enter search topic">
                        </div>
                        <div class="col-md-3">
                            <label for="startYear" class="form-label">Start Year</label>
                            <input type="number" class="form-control" id="startYear" required
                                   min="1900" max="2024" value="2010">
                        </div>
                        <div class="col-md-3">
                            <label for="endYear" class="form-label">End Year</label>
                            <input type="number" class="form-control" id="endYear" required
                                   min="1900" max="2024" value="2024">
                        </div>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col">
                            <label class="form-label">Companies</label>
                            <div class="d-flex flex-wrap gap-3" id="companiesList">
                                <!-- Companies will be loaded dynamically -->
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" style="display: none;">
            <div class="row mb-4">
                <div class="col">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Publication Trends</h5>
                            <div class="chart-container">
                                <canvas id="trendsChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title mb-0">Results Summary</h5>
                        <button class="btn btn-success" id="exportBtn">
                            <i class="bi bi-download"></i> Export to CSV
                        </button>
                    </div>
                    <div class="results-table">
                        <table class="table table-striped" id="resultsTable">
                            <thead>
                                <tr>
                                    <th>Year</th>
                                    <!-- Company columns will be added dynamically -->
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detail View -->
        <div id="detailView" class="detail-view">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="card-title" id="detailTitle"></h5>
                        <button class="btn btn-secondary" id="backToSummary">
                            <i class="bi bi-arrow-left"></i> Back to Summary
                        </button>
                    </div>
                    <div id="detailContent"></div>
                    <nav aria-label="Publication navigation">
                        <ul class="pagination justify-content-center" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentResults = null;
        let trendsChart = null;
        let companies = {};

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            const currentYear = new Date().getFullYear();
            document.getElementById('endYear').value = currentYear - 1;
            document.getElementById('startYear').value = currentYear - 11;
            loadCompanies();
        });

        // Load companies from the server
        async function loadCompanies() {
            try {
                const response = await fetch('/api/companies');
                companies = await response.json();
                displayCompanyCheckboxes();
            } catch (error) {
                console.error('Error loading companies:', error);
                alert('Error loading companies');
            }
        }

        // Display company checkboxes
        function displayCompanyCheckboxes() {
            const list = document.getElementById('companiesList');
            list.innerHTML = '';

            // Sort companies by display order
            const sortedCompanies = Object.entries(companies)
                .sort((a, b) => (a[1].display_order || 0) - (b[1].display_order || 0));

            for (const [name, data] of sortedCompanies) {
                const div = document.createElement('div');
                div.className = 'form-check';
                div.innerHTML = `
                    <input class="form-check-input company" type="checkbox" 
                           value="${name}" id="${name.toLowerCase()}" checked>
                    <label class="form-check-label" for="${name.toLowerCase()}">${name}</label>
                `;
                list.appendChild(div);
            }
        }

        // Display results in table and chart
        function updateResults(data) {
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('detailView').style.display = 'none';
            
            // Store current results for export
            currentResults = data;
            
            // Update table
            const table = document.getElementById('resultsTable');
            const thead = table.querySelector('thead tr');
            const tbody = table.querySelector('tbody');
            
            // Clear existing content
            thead.innerHTML = '<th>Year</th>';
            tbody.innerHTML = '';
            
            // Add company columns
            data.manufacturers.forEach(company => {
                thead.innerHTML += `<th>${company}</th>`;
            });
            thead.innerHTML += '<th>Total</th>';
            
            // Add data rows
            data.years.forEach(year => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${year}</td>`;
                
                data.manufacturers.forEach(company => {
                    const count = data.counts[year][company];
                    row.innerHTML += `
                        <td>
                            <a href="#" onclick="showDetails('${company}', ${year})">${count}</a>
                        </td>`;
                });
                
                row.innerHTML += `<td>${data.totals_by_year[year]}</td>`;
                tbody.appendChild(row);
            });
            
            // Add totals row
            const totalsRow = document.createElement('tr');
            totalsRow.innerHTML = '<td><strong>Total</strong></td>';
            data.manufacturers.forEach(company => {
                totalsRow.innerHTML += `<td><strong>${data.totals_by_manufacturer[company]}</strong></td>`;
            });
            const grandTotal = Object.values(data.totals_by_manufacturer).reduce((a, b) => a + b, 0);
            totalsRow.innerHTML += `<td><strong>${grandTotal}</strong></td>`;
            tbody.appendChild(totalsRow);
            
            // Update chart
            updateChart(data);
        }

        // Get selected companies
        function getSelectedCompanies() {
            return Array.from(document.querySelectorAll('.company:checked'))
                .map(cb => cb.value);
        }

        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            await performSearch();
        });

        async function performSearch() {
            const topic = document.getElementById('topic').value.trim();
            const startYear = parseInt(document.getElementById('startYear').value);
            const endYear = parseInt(document.getElementById('endYear').value);
            const selectedCompanies = getSelectedCompanies();

            if (!startYear || !endYear || selectedCompanies.length === 0) {
                alert('Please fill in all required fields (start year, end year, and at least one company)');
                return;
            }

            if (endYear < startYear) {
                alert('End year must be greater than or equal to start year');
                return;
            }

            // Show loading state
            const searchButton = document.querySelector('#searchForm button[type="submit"]');
            const spinner = searchButton.querySelector('.spinner-border');
            searchButton.disabled = true;
            if (spinner) spinner.classList.remove('d-none');
            document.getElementById('resultsSection').style.display = 'none';

            try {
                // Build and display the search string
                const searchString = buildSearchString(topic, selectedCompanies, startYear, endYear);
                displaySearchString(searchString);

                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        topic: topic,
                        start_year: startYear,
                        end_year: endYear,
                        manufacturers: selectedCompanies
                    })
                });

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update results table and show results section
                updateResults(data);
                
                // Make sure search string is visible after results are displayed
                document.getElementById('searchStringSection').style.display = 'block';
            } catch (error) {
                alert('Error performing search: ' + error.message);
            } finally {
                // Reset loading state
                searchButton.disabled = false;
                if (spinner) spinner.classList.add('d-none');
            }
        }

        // Build PubMed search string
        function buildSearchString(topic, selectedCompanies, startYear, endYear) {
            // Topic (only include if not blank)
            let searchTerms = [];
            if (topic.trim()) {
                searchTerms.push(`(${topic})`);
            }
            
            // Get current year as fallback for end_year "present"
            const currentYear = new Date().getFullYear();
            
            // Company affiliations combined with OR
            const companyTerms = [];
            
            // Process each selected company
            for (const companyName of selectedCompanies) {
                const company = companies[companyName];
                if (!company) {
                    companyTerms.push(`"${companyName}"[Affiliation]`);
                    companyTerms.push(`"${companyName}"[Grant Number]`);
                    companyTerms.push(`"${companyName}"[Grant]`);
                    continue;
                }
                
                const companyAffiliations = [];
                
                // Add variations based on year range
                if (company.variations && Array.isArray(company.variations)) {
                    company.variations.forEach(variation => {
                        if (variation.end_year >= startYear && variation.start_year <= endYear) {
                            companyAffiliations.push(`"${variation.name}"[Affiliation]`);
                            companyAffiliations.push(`"${variation.name}"[Grant Number]`);
                            companyAffiliations.push(`"${variation.name}"[Grant]`);
                        }
                    });
                }
                
                // Add acquisitions that happened before or during the date range
                if (company.acquisitions && Array.isArray(company.acquisitions)) {
                    company.acquisitions.forEach(acq => {
                        if (acq.year <= endYear) {
                            companyAffiliations.push(`"${acq.name}"[Affiliation]`);
                            companyAffiliations.push(`"${acq.name}"[Grant Number]`);
                            companyAffiliations.push(`"${acq.name}"[Grant]`);
                        }
                    });
                }
                
                // If no variations/acquisitions were added, use the company name itself
                if (companyAffiliations.length === 0) {
                    companyAffiliations.push(`"${companyName}"[Affiliation]`);
                    companyAffiliations.push(`"${companyName}"[Grant Number]`);
                    companyAffiliations.push(`"${companyName}"[Grant]`);
                }
                
                companyTerms.push(...companyAffiliations);
            }
            
            if (companyTerms.length > 0) {
                searchTerms.push(`(${companyTerms.join(" OR ")})`);
            }
            
            // Add year range using the full PubMed date format
            searchTerms.push(`"${startYear}/01/01"[Date - Publication]:"${endYear}/12/31"[Date - Publication]`);
            
            return searchTerms.join(" AND ");
        }

        // Display search string and update PubMed link
        function displaySearchString(searchString) {
            const searchStringElement = document.getElementById('searchString');
            const searchStringSection = document.getElementById('searchStringSection');
            const pubmedLink = document.getElementById('pubmedLink');
            
            searchStringElement.textContent = searchString;
            searchStringSection.style.display = 'block';
            pubmedLink.href = `https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(searchString)}`;
        }

        // Copy search string to clipboard
        function copySearchString() {
            const searchString = document.getElementById('searchString').textContent;
            navigator.clipboard.writeText(searchString).then(() => {
                alert('Search string copied to clipboard!');
            }).catch(err => {
                console.error('Error copying text: ', err);
                alert('Failed to copy search string');
            });
        }

        // Update the trends chart
        function updateChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            const datasets = data.manufacturers.map(company => ({
                label: company,
                data: data.years.map(year => data.counts[year][company]),
                fill: false
            }));
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.years,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Publications'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });
        }

        // Show detailed results
        async function showDetails(company, year) {
            showLoading();
            
            try {
                const topic = document.getElementById('topic').value;
                const response = await fetch(`/details?topic=${encodeURIComponent(topic)}&manufacturer=${encodeURIComponent(company)}&year=${year}`);
                const data = await response.json();
                
                if (response.ok) {
                    displayDetails(data, company, year);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error fetching details: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // Display detailed results
        function displayDetails(data, company, year) {
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('detailView').style.display = 'block';
            
            document.getElementById('detailTitle').textContent = 
                `Publications for ${company} in ${year} (${data.count} results)`;
            
            const content = document.getElementById('detailContent');
            content.innerHTML = '';
            
            data.results.forEach(article => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${article.title}</h5>
                        <p class="card-text">
                            <strong>Authors:</strong> ${article.authors.join(', ')}<br>
                            <strong>Journal:</strong> ${article.journal}<br>
                            <strong>Publication Date:</strong> ${article.pubdate}
                        </p>
                        ${article.doi ? `
                            <a href="https://doi.org/${article.doi}" target="_blank" class="btn btn-primary btn-sm">
                                <i class="bi bi-box-arrow-up-right"></i> View Article
                            </a>
                        ` : ''}
                    </div>
                `;
                content.appendChild(card);
            });
        }

        // Handle export button click
        document.getElementById('exportBtn').addEventListener('click', async function() {
            if (!currentResults) return;
            
            try {
                const response = await fetch('/export', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        results: currentResults
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'pubmed_results.csv';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                } else {
                    const data = await response.json();
                    alert('Error: ' + data.error);
                }
            } catch (error) {
                alert('Error exporting results: ' + error.message);
            }
        });

        // Handle back button click
        document.getElementById('backToSummary').addEventListener('click', function() {
            document.getElementById('detailView').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'block';
        });

        // Loading indicator functions
        function showLoading() {
            document.querySelector('.loading').style.display = 'flex';
        }

        function hideLoading() {
            document.querySelector('.loading').style.display = 'none';
        }
    </script>
</body>
</html> 