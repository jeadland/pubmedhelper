{% extends "base.html" %}

{% block title %}Home{% endblock %}

{% block styles %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    .loading {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }
    .results-table {
        max-height: 500px;
        overflow-y: auto;
    }
    .chart-container {
        height: 400px;
        margin-bottom: 2rem;
    }
    .detail-view {
        display: none;
    }
    .section {
        display: none;
    }
    .section.active {
        display: block;
    }
    /* Styles for the results per page dropdown */
    #resultsPerPage, #basicResultsPerPage {
        border: 1px solid #007bff;
        transition: all 0.3s ease;
    }
    #resultsPerPage:hover, #basicResultsPerPage:hover {
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    #resultsPerPage:focus, #basicResultsPerPage:focus {
        border-color: #0056b3;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);
    }
    label[for="resultsPerPage"], label[for="basicResultsPerPage"] {
        color: #007bff;
        font-weight: 500;
    }
</style>
{% endblock %}

{% block content %}
<div class="loading">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Basic Search Section -->
<div id="basicSearchSection" class="section">
    <h2 class="mb-4">Basic PubMed Search</h2>
    <div class="card mb-4">
        <div class="card-body">
            <form id="basicSearchForm">
                <div class="mb-3">
                    <label for="searchQuery" class="form-label">Search Query</label>
                    <input type="text" class="form-control" id="searchQuery" required placeholder="Enter your search terms">
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="basicStartYear" class="form-label">Start Year</label>
                        <input type="number" class="form-control" id="basicStartYear" required min="1900" max="2024" value="2010">
                    </div>
                    <div class="col-md-6">
                        <label for="basicEndYear" class="form-label">End Year</label>
                        <input type="number" class="form-control" id="basicEndYear" required min="1900" max="2024" value="2024">
                    </div>
                </div>
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>
    <div id="basicSearchResults" style="display: none;">
        <!-- Basic search results will go here -->
    </div>
</div>

<!-- Company Comparison Section -->
<div id="companyComparisonSection" class="section">
    <h2 class="mb-4">Company Publication Comparison</h2>
    
    <!-- Search String Display -->
    <div class="card mb-4" id="searchStringSection" style="display: none;">
        <div class="card-body">
            <h5 class="card-title">PubMed Search String</h5>
            <div class="alert alert-info">
                <p><small>Copy this string to search in PubMed directly or click the button below to open in PubMed:</small></p>
                <div class="d-flex align-items-center gap-2">
                    <code class="bg-light p-2 flex-grow-1" id="searchString" style="word-break: break-all; max-height: 150px; overflow-y: auto; display: block;"></code>
                    <div class="d-flex flex-column gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="copySearchString()">
                            <i class="bi bi-clipboard"></i> Copy
                        </button>
                        <a id="pubmedLink" href="#" target="_blank" class="btn btn-outline-success btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i> Open in PubMed
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="searchForm">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="topic">Topic (optional - leave blank to see all company publications)</label>
                        <input type="text" class="form-control" id="topic" placeholder="Enter search topic">
                    </div>
                    <div class="col-md-3">
                        <label for="startYear" class="form-label">Start Year</label>
                        <input type="number" class="form-control" id="startYear" required min="1900" max="2024" value="2010">
                    </div>
                    <div class="col-md-3">
                        <label for="endYear" class="form-label">End Year</label>
                        <input type="number" class="form-control" id="endYear" required min="1900" max="2024" value="2024">
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col">
                        <label class="form-label">Companies</label>
                        <div class="d-flex flex-wrap gap-3" id="companiesList">
                            <!-- Companies will be loaded dynamically -->
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Section -->
    <div id="resultsSection" style="display: none;">
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Publication Trends</h5>
                        <div class="chart-container">
                            <canvas id="trendsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="card-title mb-0">Results Summary</h5>
                    <button class="btn btn-success" id="exportBtn">
                        <i class="bi bi-download"></i> Export to CSV
                    </button>
                </div>
                <div class="results-table">
                    <table class="table table-striped" id="resultsTable">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <!-- Company columns will be added dynamically -->
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Detail View -->
    <div id="detailView" style="display: none;">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-4 flex-wrap">
                    <h5 class="card-title m-0 mb-2 mb-md-0" id="detailTitle"></h5>
                    <div class="d-flex align-items-center gap-2 flex-wrap">
                        <div class="d-flex align-items-center me-2">
                            <label for="resultsPerPage" class="mb-0 me-2">Results per page:</label>
                            <select class="form-select form-select-sm" id="resultsPerPage" style="width: 70px;" 
                                    title="Change the number of results shown per page">
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="250">250</option>
                            </select>
                        </div>
                        <button class="btn btn-secondary" id="backToSummary">
                            <i class="bi bi-arrow-left"></i> Back to Summary
                        </button>
                    </div>
                </div>
                <div id="detailContent"></div>
                <nav aria-label="Publication navigation" class="mt-4">
                    <ul class="pagination justify-content-center" id="pagination"></ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<div id="progressContainer" class="mt-4" style="display: none;">
    <div class="card">
        <div class="card-body">
            <h5 class="card-title">Search Progress</h5>
            <div class="progress mb-3">
                <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
            </div>
            <p id="progressStatus" class="mb-2">Starting search...</p>
            <p id="progressTime" class="text-muted small"></p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Existing variables
    let currentResults = null;
    let trendsChart = null;
    let companies = {};
    let searchStartTime;
    let progressInterval;

    // Navigation handling
    document.addEventListener('DOMContentLoaded', function() {
        const basicSearchLink = document.getElementById('basicSearchLink');
        const companyComparisonLink = document.getElementById('companyComparisonLink');
        const basicSearchSection = document.getElementById('basicSearchSection');
        const companyComparisonSection = document.getElementById('companyComparisonSection');

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        basicSearchLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('basicSearchSection');
            basicSearchLink.classList.add('active');
            companyComparisonLink.classList.remove('active');
        });

        companyComparisonLink.addEventListener('click', (e) => {
            e.preventDefault();
            showSection('companyComparisonSection');
            companyComparisonLink.classList.add('active');
            basicSearchLink.classList.remove('active');
        });

        // Show company comparison by default
        showSection('companyComparisonSection');
        companyComparisonLink.classList.add('active');

        // Initialize the page
        const currentYear = new Date().getFullYear();
        document.getElementById('endYear').value = currentYear - 1;
        document.getElementById('startYear').value = currentYear - 11;
        document.getElementById('basicEndYear').value = currentYear - 1;
        document.getElementById('basicStartYear').value = currentYear - 11;
        loadCompanies();

        // Handle basic search form submission
        document.getElementById('basicSearchForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const query = document.getElementById('searchQuery').value;
            const startYear = parseInt(document.getElementById('basicStartYear').value);
            const endYear = parseInt(document.getElementById('basicEndYear').value);

            if (!query || !startYear || !endYear) {
                alert('Please fill in all required fields');
                return;
            }

            if (endYear < startYear) {
                alert('End year must be greater than or equal to start year');
                return;
            }

            // Default to 20 results per page for initial search
            const resultsPerPage = 20;
            
            // Use our shared function for performing the search
            await performBasicSearch(query, startYear, endYear, 1, resultsPerPage);
        });
    });

    // Load companies from the server
    async function loadCompanies() {
        try {
            const response = await fetch('/api/companies');
            companies = await response.json();
            displayCompanyCheckboxes();
        } catch (error) {
            console.error('Error loading companies:', error);
            alert('Error loading companies');
        }
    }

    // Display company checkboxes
    function displayCompanyCheckboxes() {
        const list = document.getElementById('companiesList');
        list.innerHTML = '';

        // Sort companies by display order
        const sortedCompanies = Object.entries(companies)
            .sort((a, b) => (a[1].display_order || 0) - (b[1].display_order || 0));

        for (const [name, data] of sortedCompanies) {
            const div = document.createElement('div');
            div.className = 'form-check';
            div.innerHTML = `
                <input class="form-check-input company" type="checkbox" 
                       value="${name}" id="${name.toLowerCase()}" checked>
                <label class="form-check-label" for="${name.toLowerCase()}">${name}</label>
            `;
            list.appendChild(div);
        }
    }

    // Display results in table and chart
    function updateResults(data) {
        document.getElementById('resultsSection').style.display = 'block';
        document.getElementById('detailView').style.display = 'none';
        
        // Store current results for export
        currentResults = data;
        
        // Update table
        const table = document.getElementById('resultsTable');
        const thead = table.querySelector('thead tr');
        const tbody = table.querySelector('tbody');
        
        // Clear existing content
        thead.innerHTML = '<th>Year</th>';
        tbody.innerHTML = '';
        
        // Add company columns
        data.manufacturers.forEach(company => {
            thead.innerHTML += `<th>${company}</th>`;
        });
        thead.innerHTML += '<th>Total</th>';
        
        // Add data rows
        data.years.forEach(year => {
            const row = document.createElement('tr');
            row.innerHTML = `<td>${year}</td>`;
            
            data.manufacturers.forEach(company => {
                const count = data.counts[year][company];
                row.innerHTML += `
                    <td>
                        <a href="#" onclick="showDetails('${company}', ${year})">${count}</a>
                    </td>`;
            });
            
            row.innerHTML += `<td>${data.totals_by_year[year]}</td>`;
            tbody.appendChild(row);
        });
        
        // Add totals row
        const totalsRow = document.createElement('tr');
        totalsRow.innerHTML = '<td><strong>Total</strong></td>';
        data.manufacturers.forEach(company => {
            totalsRow.innerHTML += `<td><strong>${data.totals_by_manufacturer[company]}</strong></td>`;
        });
        const grandTotal = Object.values(data.totals_by_manufacturer).reduce((a, b) => a + b, 0);
        totalsRow.innerHTML += `<td><strong>${grandTotal}</strong></td>`;
        tbody.appendChild(totalsRow);
        
        // Update chart
        updateChart(data);
    }

    // Get selected companies
    function getSelectedCompanies() {
        return Array.from(document.querySelectorAll('.company:checked'))
            .map(cb => cb.value);
    }

    // Handle form submission
    document.getElementById('searchForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await startSearch();
    });

    async function startSearch() {
        // Show progress container and start tracking time
        const progressContainer = document.getElementById('progressContainer');
        progressContainer.style.display = 'block';
        searchStartTime = Date.now();
        
        // Start progress polling
        progressInterval = setInterval(updateProgress, 1000);
        
        const topic = document.getElementById('topic').value.trim();
        const startYear = parseInt(document.getElementById('startYear').value);
        const endYear = parseInt(document.getElementById('endYear').value);
        const selectedCompanies = getSelectedCompanies();

        if (!startYear || !endYear || selectedCompanies.length === 0) {
            alert('Please fill in all required fields (start year, end year, and at least one company)');
            return;
        }

        if (endYear < startYear) {
            alert('End year must be greater than or equal to start year');
            return;
        }

        // Show loading state
        const searchButton = document.querySelector('#searchForm button[type="submit"]');
        const spinner = searchButton.querySelector('.spinner-border');
        searchButton.disabled = true;
        if (spinner) spinner.classList.remove('d-none');
        document.getElementById('resultsSection').style.display = 'none';

        try {
            // Build and display the search string
            const searchString = buildSearchString(topic, selectedCompanies, startYear, endYear);
            displaySearchString(searchString);

            const response = await fetch('/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    topic: topic,
                    start_year: startYear,
                    end_year: endYear,
                    manufacturers: selectedCompanies
                })
            });

            if (!response.ok) {
                throw new Error('Search failed');
            }

            const data = await response.json();
            
            if (data.error) {
                throw new Error(data.error);
            }

            // Update results table and show results section
            updateResults(data);
            
            // Make sure search string is visible after results are displayed
            document.getElementById('searchStringSection').style.display = 'block';
        } catch (error) {
            alert('Error performing search: ' + error.message);
        } finally {
            // Reset loading state
            searchButton.disabled = false;
            if (spinner) spinner.classList.add('d-none');
        }
    }

    // Build PubMed search string
    function buildSearchString(topic, selectedCompanies, startYear, endYear) {
        // Topic (only include if not blank)
        let searchTerms = [];
        if (topic.trim()) {
            searchTerms.push(`(${topic})`);
        }
        
        // Company affiliations combined with OR
        const companyTerms = [];
        
        // Process each selected company
        for (const companyName of selectedCompanies) {
            const company = companies[companyName];
            if (!company) {
                // Add both full name and abbreviation if available
                if (companyName.includes('General Electric')) {
                    companyTerms.push(`${companyName}[Affiliation]`);
                    companyTerms.push(`${companyName}[Grant Number]`);
                    companyTerms.push(`GE[Affiliation]`);
                    companyTerms.push(`GE[Grant Number]`);
                } else {
                    companyTerms.push(`${companyName}[Affiliation]`);
                    companyTerms.push(`${companyName}[Grant Number]`);
                }
                continue;
            }
            
            const companyAffiliations = [];
            
            // Add variations based on year range
            if (company.variations && Array.isArray(company.variations)) {
                company.variations.forEach(variation => {
                    if (variation.end_year >= startYear && variation.start_year <= endYear) {
                        companyAffiliations.push(`${variation.name}[Affiliation]`);
                        companyAffiliations.push(`${variation.name}[Grant Number]`);
                    }
                });
            }
            
            // Add acquisitions that happened before or during the date range
            if (company.acquisitions && Array.isArray(company.acquisitions)) {
                company.acquisitions.forEach(acq => {
                    if (acq.year <= endYear) {
                        companyAffiliations.push(`${acq.name}[Affiliation]`);
                        companyAffiliations.push(`${acq.name}[Grant Number]`);
                    }
                });
            }
            
            // If no variations/acquisitions were added, use the company name itself
            if (companyAffiliations.length === 0) {
                companyAffiliations.push(`${companyName}[Affiliation]`);
                companyAffiliations.push(`${companyName}[Grant Number]`);
            }
            
            companyTerms.push(...companyAffiliations);
        }
        
        if (companyTerms.length > 0) {
            searchTerms.push(`(${companyTerms.join(" OR ")})`);
        }
        
        // Add year range using the full PubMed date format
        searchTerms.push(`"${startYear}/01/01"[Date - Publication]:"${endYear}/12/31"[Date - Publication]`);
        
        return searchTerms.join(" AND ");
    }

    // Display search string and update PubMed link
    function displaySearchString(searchString) {
        const searchStringElement = document.getElementById('searchString');
        const searchStringSection = document.getElementById('searchStringSection');
        const pubmedLink = document.getElementById('pubmedLink');
        
        searchStringElement.textContent = searchString;
        searchStringSection.style.display = 'block';
        pubmedLink.href = `https://pubmed.ncbi.nlm.nih.gov/?term=${encodeURIComponent(searchString)}`;
    }

    // Copy search string to clipboard
    function copySearchString() {
        const searchString = document.getElementById('searchString').textContent;
        navigator.clipboard.writeText(searchString).then(() => {
            alert('Search string copied to clipboard!');
        }).catch(err => {
            console.error('Error copying text: ', err);
            alert('Failed to copy search string');
        });
    }

    // Update the trends chart
    function updateChart(data) {
        const ctx = document.getElementById('trendsChart').getContext('2d');
        
        if (trendsChart) {
            trendsChart.destroy();
        }
        
        const datasets = data.manufacturers.map(company => ({
            label: company,
            data: data.years.map(year => data.counts[year][company]),
            fill: false
        }));
        
        trendsChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.years,
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Publications'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Year'
                        }
                    }
                }
            }
        });
    }

    // Show detailed results
    async function showDetails(company, year, page = 1) {
        showLoading();
        
        try {
            const topic = document.getElementById('topic').value;
            const resultsPerPage = parseInt(document.getElementById('resultsPerPage').value);
            const response = await fetch(`/details?topic=${encodeURIComponent(topic)}&manufacturer=${encodeURIComponent(company)}&year=${year}&page=${page}&per_page=${resultsPerPage}`);
            const data = await response.json();
            
            if (response.ok) {
                displayDetails(data, company, year);
                // Scroll to top of results when changing pages
                document.getElementById('detailView').scrollIntoView({ behavior: 'smooth' });
            } else {
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error fetching details: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Display detailed results
    function displayDetails(data, company, year) {
        document.getElementById('resultsSection').style.display = 'none';
        document.getElementById('detailView').style.display = 'block';
        
        document.getElementById('detailTitle').textContent = 
            `Publications for ${company} in ${year} (${data.count} results)`;
        
        // Set the results per page dropdown to match the current per_page value
        const resultsPerPageSelect = document.getElementById('resultsPerPage');
        const perPage = data.per_page || 100;
        
        // Find the matching option or default to the closest value
        let optionFound = false;
        for (let i = 0; i < resultsPerPageSelect.options.length; i++) {
            if (parseInt(resultsPerPageSelect.options[i].value) === perPage) {
                resultsPerPageSelect.selectedIndex = i;
                optionFound = true;
                break;
            }
        }
        
        // If no exact match, select the closest option
        if (!optionFound) {
            const values = Array.from(resultsPerPageSelect.options).map(opt => parseInt(opt.value));
            const closest = values.reduce((prev, curr) => 
                Math.abs(curr - perPage) < Math.abs(prev - perPage) ? curr : prev
            );
            
            for (let i = 0; i < resultsPerPageSelect.options.length; i++) {
                if (parseInt(resultsPerPageSelect.options[i].value) === closest) {
                    resultsPerPageSelect.selectedIndex = i;
                    break;
                }
            }
        }
        
        const content = document.getElementById('detailContent');
        content.innerHTML = '';
        
        // Display results
        if (data.results.length === 0) {
            content.innerHTML = '<div class="alert alert-info">No results found.</div>';
        } else {
            data.results.forEach(article => {
                const card = document.createElement('div');
                card.className = 'card mb-3';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">${article.title}</h5>
                        <p class="card-text">
                            <strong>Authors:</strong> ${article.authors.join(', ')}<br>
                            <strong>Journal:</strong> ${article.journal}<br>
                            <strong>Publication Date:</strong> ${article.pubdate}
                        </p>
                        ${article.doi ? `
                            <a href="https://doi.org/${article.doi}" target="_blank" class="btn btn-primary btn-sm">
                                <i class="bi bi-box-arrow-up-right"></i> View Article
                            </a>
                        ` : ''}
                    </div>
                `;
                content.appendChild(card);
            });
        }

        // Add pagination
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (data.count > 0) {
            // Use the per_page value from the response instead of hardcoded 100
            const resultsPerPage = data.per_page || parseInt(document.getElementById('resultsPerPage').value);
            const totalPages = Math.ceil(data.count / resultsPerPage);
            const currentPage = data.page || 1;
            const paginationUl = document.createElement('ul');
            paginationUl.className = 'pagination justify-content-center';
            
            // Previous button with arrow
            paginationUl.innerHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" aria-label="Previous" onclick="event.preventDefault(); showDetails('${company}', ${year}, ${currentPage - 1});">
                        <span aria-hidden="true">&laquo;</span>
                    </a>
                </li>
            `;

            // Function to add page number
            const addPageNumber = (pageNum) => {
                paginationUl.innerHTML += `
                    <li class="page-item ${pageNum === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" onclick="event.preventDefault(); showDetails('${company}', ${year}, ${pageNum});">
                            ${pageNum}
                        </a>
                    </li>
                `;
            };

            // Function to add ellipsis
            const addEllipsis = () => {
                paginationUl.innerHTML += `
                    <li class="page-item disabled">
                        <span class="page-link">...</span>
                    </li>
                `;
            };

            // First page
            addPageNumber(1);

            // Calculate visible page range
            let startPage = Math.max(2, currentPage - 2);
            let endPage = Math.min(totalPages - 1, currentPage + 2);

            // Adjust for edge cases
            if (currentPage <= 4) {
                endPage = Math.min(6, totalPages - 1);
            } else if (currentPage >= totalPages - 3) {
                startPage = Math.max(totalPages - 5, 2);
            }

            // Add ellipsis and pages
            if (startPage > 2) addEllipsis();
            for (let i = startPage; i <= endPage; i++) {
                addPageNumber(i);
            }
            if (endPage < totalPages - 1) addEllipsis();

            // Last page if not already shown
            if (totalPages > 1) {
                addPageNumber(totalPages);
            }

            // Next button with arrow
            paginationUl.innerHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" aria-label="Next" onclick="event.preventDefault(); showDetails('${company}', ${year}, ${currentPage + 1});">
                        <span aria-hidden="true">&raquo;</span>
                    </a>
                </li>
            `;

            pagination.appendChild(paginationUl);
            
            // Add page info text
            const pageInfo = document.createElement('div');
            pageInfo.className = 'text-center mt-2 text-muted';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages} (${resultsPerPage} results per page)`;
            pagination.appendChild(pageInfo);
        }
    }

    // Handle export button click
    document.getElementById('exportBtn').addEventListener('click', async function() {
        if (!currentResults) return;
        
        try {
            const response = await fetch('/export', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    results: currentResults
                })
            });
            
            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'pubmed_results.csv';
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } else {
                const data = await response.json();
                alert('Error: ' + data.error);
            }
        } catch (error) {
            alert('Error exporting results: ' + error.message);
        }
    });

    // Handle back button click
    document.getElementById('backToSummary').addEventListener('click', function() {
        document.getElementById('detailView').style.display = 'none';
        document.getElementById('resultsSection').style.display = 'block';
    });

    // Loading indicator functions
    function showLoading() {
        document.querySelector('.loading').style.display = 'flex';
    }

    function hideLoading() {
        document.querySelector('.loading').style.display = 'none';
    }

    // Display basic search results
    function displayBasicSearchResults(data) {
        const resultsDiv = document.getElementById('basicSearchResults');
        resultsDiv.style.display = 'block';
        resultsDiv.innerHTML = '';

        // Add summary header with results per page dropdown
        const headerDiv = document.createElement('div');
        headerDiv.className = 'alert alert-info d-flex justify-content-between align-items-center';
        
        const headerText = document.createElement('div');
        headerText.innerHTML = `Found ${data.total_count} results. Showing page ${data.current_page} of ${data.total_pages}.`;
        
        const resultsPerPageDiv = document.createElement('div');
        resultsPerPageDiv.className = 'd-flex align-items-center gap-2';
        resultsPerPageDiv.innerHTML = `
            <label for="basicResultsPerPage" class="mb-0 me-2">Results per page:</label>
            <select class="form-select form-select-sm" id="basicResultsPerPage" style="width: 70px;">
                <option value="10" ${data.results_per_page === 10 ? 'selected' : ''}>10</option>
                <option value="20" ${data.results_per_page === 20 ? 'selected' : ''}>20</option>
                <option value="50" ${data.results_per_page === 50 ? 'selected' : ''}>50</option>
                <option value="100" ${data.results_per_page === 100 ? 'selected' : ''}>100</option>
            </select>
        `;
        
        headerDiv.appendChild(headerText);
        headerDiv.appendChild(resultsPerPageDiv);
        resultsDiv.appendChild(headerDiv);
        
        // Add event listener to the results per page dropdown
        const basicResultsPerPage = document.getElementById('basicResultsPerPage');
        basicResultsPerPage.addEventListener('change', function() {
            const query = document.getElementById('searchQuery').value;
            const startYear = parseInt(document.getElementById('basicStartYear').value);
            const endYear = parseInt(document.getElementById('basicEndYear').value);
            const resultsPerPage = parseInt(this.value);
            
            performBasicSearch(query, startYear, endYear, 1, resultsPerPage);
        });

        // Display results
        data.results.forEach(article => {
            const card = document.createElement('div');
            card.className = 'card mb-3';
            card.innerHTML = `
                <div class="card-body">
                    <h5 class="card-title">${article.title}</h5>
                    <p class="card-text">
                        <strong>Authors:</strong> ${article.authors.join(', ')}<br>
                        <strong>Journal:</strong> ${article.journal}<br>
                        <strong>Publication Date:</strong> ${article.pubdate}<br>
                        ${article.abstract ? `<strong>Abstract:</strong> ${article.abstract}` : ''}
                    </p>
                    ${article.doi ? `
                        <a href="https://doi.org/${article.doi}" target="_blank" class="btn btn-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right"></i> View Article
                        </a>
                    ` : ''}
                    <a href="https://pubmed.ncbi.nlm.nih.gov/${article.pmid}" target="_blank" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-box-arrow-up-right"></i> View on PubMed
                    </a>
                </div>
            `;
            resultsDiv.appendChild(card);
        });

        // Add pagination if needed
        if (data.total_pages > 1) {
            const pagination = document.createElement('nav');
            pagination.setAttribute('aria-label', 'Search results pagination');
            
            // Get the current results per page from the dropdown or response
            const resultsPerPage = data.results_per_page || parseInt(document.getElementById('basicResultsPerPage').value) || 20;
            
            pagination.innerHTML = `
                <ul class="pagination justify-content-center">
                    <li class="page-item ${data.current_page === 1 ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${data.current_page - 1}">Previous</a>
                    </li>
                    ${Array.from({length: data.total_pages}, (_, i) => i + 1)
                        .filter(page => {
                            const delta = Math.abs(page - data.current_page);
                            return delta === 0 || delta === 1 || page === 1 || page === data.total_pages;
                        })
                        .map(page => `
                            <li class="page-item ${page === data.current_page ? 'active' : ''}">
                                <a class="page-link" href="#" data-page="${page}">${page}</a>
                            </li>
                        `).join('')}
                    <li class="page-item ${data.current_page === data.total_pages ? 'disabled' : ''}">
                        <a class="page-link" href="#" data-page="${data.current_page + 1}">Next</a>
                    </li>
                </ul>
                <div class="text-center mt-2 text-muted">
                    Page ${data.current_page} of ${data.total_pages} (${resultsPerPage} results per page)
                </div>
            `;
            resultsDiv.appendChild(pagination);

            // Add pagination event listeners
            const query = document.getElementById('searchQuery').value;
            const startYear = parseInt(document.getElementById('basicStartYear').value);
            const endYear = parseInt(document.getElementById('basicEndYear').value);
            attachBasicPaginationHandlers(pagination, query, startYear, endYear, resultsPerPage);
        }
    }

    function updateProgress() {
        fetch('/search/progress')
            .then(response => response.json())
            .then(data => {
                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                const progressStatus = document.getElementById('progressStatus');
                const progressTime = document.getElementById('progressTime');
                
                if (data.total > 0) {
                    const percent = (data.current / data.total) * 100;
                    progressBar.style.width = `${percent}%`;
                    progressBar.setAttribute('aria-valuenow', percent);
                    progressStatus.textContent = data.status;
                    
                    // Calculate and display estimated time
                    const elapsedTime = (Date.now() - searchStartTime) / 1000;
                    const estimatedTotalTime = (elapsedTime / percent) * 100;
                    const remainingTime = estimatedTotalTime - elapsedTime;
                    
                    if (percent > 0) {
                        progressTime.textContent = `Elapsed: ${Math.round(elapsedTime)}s | Estimated remaining: ${Math.round(remainingTime)}s`;
                    }
                    
                    progressContainer.style.display = 'block';
                }
                
                if (data.complete) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                    }, 3000);
                }
            });
    }

    // Add event listener for results per page change
    document.addEventListener('DOMContentLoaded', function() {
        const resultsPerPageSelect = document.getElementById('resultsPerPage');
        
        resultsPerPageSelect.addEventListener('change', function() {
            // Get the current company and year from the title
            const title = document.getElementById('detailTitle').textContent;
            const companyMatch = title.match(/Publications for (.*?) in/);
            const yearMatch = title.match(/in (\d{4})/);
            
            if (companyMatch && yearMatch) {
                const company = companyMatch[1];
                const year = parseInt(yearMatch[1]);
                
                // Provide visual feedback
                const originalLabel = document.querySelector('label[for="resultsPerPage"]').textContent;
                document.querySelector('label[for="resultsPerPage"]').textContent = 'Updating...';
                
                // Reset to first page when changing results per page
                showDetails(company, year, 1).then(() => {
                    // Reset label back to original
                    document.querySelector('label[for="resultsPerPage"]').textContent = originalLabel;
                });
            }
        });
    });

    // Function to perform basic search with pagination and results per page
    async function performBasicSearch(query, startYear, endYear, page = 1, resultsPerPage = 20) {
        showLoading();
        try {
            const response = await fetch('/basic_search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: query,
                    start_year: startYear,
                    end_year: endYear,
                    page: page,
                    results_per_page: resultsPerPage
                })
            });

            if (!response.ok) {
                throw new Error('Search failed');
            }

            const data = await response.json();
            if (data.error) {
                throw new Error(data.error);
            }

            displayBasicSearchResults(data);
            window.scrollTo(0, document.getElementById('basicSearchResults').offsetTop - 20);
        } catch (error) {
            alert('Error performing search: ' + error.message);
        } finally {
            hideLoading();
        }
    }

    // Update the pagination click handler for basic search
    function attachBasicPaginationHandlers(pagination, query, startYear, endYear, resultsPerPage) {
        pagination.addEventListener('click', async function(e) {
            e.preventDefault();
            if (e.target.classList.contains('page-link')) {
                const page = parseInt(e.target.dataset.page);
                if (!isNaN(page)) {
                    await performBasicSearch(query, startYear, endYear, page, resultsPerPage);
                }
            }
        });
    }
</script>
{% endblock %} 